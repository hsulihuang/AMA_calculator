<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMA/California Calculator by Hsuli</title>
</head>
<body>
    <h1>AMA/California Calculator</h1>
    <h2>by Hsuli (beta version 0.1)</h2>
    <form id="ama-form">
        <!-- Impairment Standard -->
        <label for="impairment_standard">Impairment Standard:</label>
        <input type="text" id="impairment_standard" name="impairment_standard" required><br><br>

        <!-- Category -->
        <label for="category">Category:</label>
        <select id="category" name="category" required>
            <option value="">Select Category</option>
            {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select><br><br>
        
        <!-- Impairment Number -->
        <label for="impairment_number">Impairment Number:</label>
        <select id="impairment_number" name="impairment_number" required>
            <option value="">Select Impairment Number</option>
        </select><br><br>

        <!-- Occupational Group -->
        <label for="occupational_group">Occupational Group:</label>
        <input type="text" id="occupational_group" name="occupational_group" required><br><br>

        <!-- Age -->
        <label for="age">Age:</label>
        <input type="number" id="age" name="age" required><br><br>

        <!-- Submit Button -->
        <button type="submit">Calculate</button>
    </form>

    <!-- Result Section -->
    <h2>Result:</h2>
    <div id="result"></div>
    
    <script>
        document.getElementById('category').addEventListener('change', function() {
            const selectedCategory = this.value;
            const impairmentDropdown = document.getElementById('impairment_number');
            impairmentDropdown.innerHTML = '<option value="">Select Impairment Number</option>';
    
            if (selectedCategory) {
                fetch(`/get_impairment_numbers?category=${selectedCategory}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            console.log("No impairment numbers found for the selected category.");
                        }
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.Impairment_Number;  // This value will still be the Impairment Number
                            option.text = item.Impairment_Description; // Display the description in the dropdown
                            impairmentDropdown.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching impairment numbers:", error);
                    });
            }
        });

        document.getElementById('ama-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            fetch('/calculate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `<p>Adjusted WPI = ${data.age_adjustment}%</p>`;
            })
            .catch(error => {
                console.error("Error calculating:", error);
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `<p style="color: red;">An error occurred while calculating. Please try again.</p>`;
            });
        });
    </script>
</body>
</html>
